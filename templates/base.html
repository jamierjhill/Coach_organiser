<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Free tennis session organizer for coaches. Create balanced sessions instantly with our grade-based algorithm.">
  
  <title>{% block title %}🎾 Tennis Session Organizer{% endblock %}</title>
  
  <!-- Enhanced Google Analytics with improved tracking -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FL37QBZMLC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    
    // Enhanced GA configuration
    gtag('config', 'G-FL37QBZMLC', {
      // Enhanced measurement for better insights
      enhanced_measurements: true,
      
      // Custom parameters for tennis app
      custom_map: {
        'custom_parameter_1': 'match_type',
        'custom_parameter_2': 'player_count',
        'custom_parameter_3': 'court_count'
      },
      
      // Page view tracking with custom data
      page_title: document.title,
      page_location: window.location.href
    });
    
    // Custom event tracking functions for tennis app
    window.trackTennisEvent = function(action, category, label, value, customParams) {
      const eventData = {
        event_category: category || 'Tennis App',
        event_label: label || '',
        value: value || 0
      };
      
      // Add custom parameters if provided
      if (customParams) {
        Object.assign(eventData, customParams);
      }
      
      gtag('event', action, eventData);
    };
    
    // Track user engagement milestones
    window.trackEngagement = function(milestone, details) {
      gtag('event', 'engagement', {
        event_category: 'User Engagement',
        event_label: milestone,
        custom_parameter_1: details.match_type || '',
        custom_parameter_2: details.player_count || 0,
        custom_parameter_3: details.court_count || 0
      });
    };
    
    // Track feature usage
    window.trackFeatureUsage = function(feature, success, details) {
      gtag('event', 'feature_usage', {
        event_category: 'Feature Usage',
        event_label: feature,
        success: success,
        match_type: details.match_type || '',
        player_count: details.player_count || 0,
        court_count: details.court_count || 0,
        rounds: details.rounds || 0
      });
    };
    
    // Track session quality metrics
    window.trackSessionQuality = function(quality, details) {
      gtag('event', 'session_quality', {
        event_category: 'Session Quality',
        event_label: quality,
        players_added: details.players_added || 0,
        matches_organized: details.matches_organized || 0,
        reshuffles: details.reshuffles || 0,
        session_duration: details.session_duration || 0
      });
    };
    
    // Track errors and issues
    window.trackError = function(error_type, error_message, context) {
      gtag('event', 'exception', {
        description: error_type + ': ' + error_message,
        fatal: false,
        error_context: context || 'unknown',
        event_category: 'Errors'
      });
    };
    
    // Track performance metrics
    window.trackPerformance = function(metric, value, context) {
      gtag('event', 'timing_complete', {
        name: metric,
        value: value,
        event_category: 'Performance',
        event_label: context || ''
      });
    };
    
    // Enhanced page view tracking with custom dimensions
    window.trackPageView = function(page_path, custom_data) {
      const pageData = {
        page_path: page_path,
        page_title: document.title
      };
      
      if (custom_data) {
        Object.assign(pageData, custom_data);
      }
      
      gtag('config', 'G-FL37QBZMLC', pageData);
    };
    
    // Track user journey milestones
    let userJourney = {
      start_time: Date.now(),
      players_added: 0,
      matches_organized: 0,
      reshuffles: 0,
      errors: 0
    };
    
    // Auto-track page engagement time
    let pageStartTime = Date.now();
    let isPageVisible = true;
    
    // Track when user becomes inactive
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        isPageVisible = false;
        const engagementTime = Date.now() - pageStartTime;
        if (engagementTime > 10000) { // Only track if engaged for more than 10 seconds
          gtag('event', 'page_engagement', {
            event_category: 'Engagement',
            event_label: 'page_time',
            value: Math.round(engagementTime / 1000), // Convert to seconds
            page_path: window.location.pathname
          });
        }
      } else {
        isPageVisible = true;
        pageStartTime = Date.now();
      }
    });
    
    // Track when user leaves page
    window.addEventListener('beforeunload', function() {
      if (isPageVisible) {
        const totalEngagementTime = Date.now() - pageStartTime;
        const sessionDuration = Date.now() - userJourney.start_time;
        
        // Track session summary
        gtag('event', 'session_summary', {
          event_category: 'Session Complete',
          session_duration: Math.round(sessionDuration / 1000),
          players_added: userJourney.players_added,
          matches_organized: userJourney.matches_organized,
          reshuffles: userJourney.reshuffles,
          errors: userJourney.errors,
          final_engagement: Math.round(totalEngagementTime / 1000)
        });
      }
    });
  </script>
  
  <!-- Optimized CSS loading -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="/static/colours.css" rel="stylesheet">
  
  {% block extra_css %}{% endblock %}
</head>

<body>
  <!-- Enhanced Header with Navigation -->
  <header class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="/" onclick="trackTennisEvent('click', 'Navigation', 'brand_logo')">
        <span>🎾</span>
        <span>Tennis Session Organizer</span>
      </a>
      
      <!-- Navigation Toggle for Mobile -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"
              style="border: none; padding: 0.25rem 0.5rem;">
        <span style="font-size: 1.2rem;">☰</span>
      </button>
      
      <!-- Navigation Menu -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/" onclick="trackTennisEvent('click', 'Navigation', 'home_link')">
              🎾 Session Organiser
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/weather" onclick="trackTennisEvent('click', 'Navigation', 'weather_link')">
              🌤️ Weather
            </a>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="{% block container_class %}container{% endblock %}" style="padding-top: 2rem; padding-bottom: 4rem;">
    {% block content %}{% endblock %}
  </main>

  <!-- Minimal Footer -->
  <footer style="text-align: center; padding: 2rem 0; color: var(--text-muted); border-top: 1px solid var(--border-light); margin-top: 3rem;">
    <div class="container">
      <p style="margin: 0; font-size: 0.875rem;">
        Tennis Session Organizer | 
        <a href="/contact" style="color: var(--text-muted); text-decoration: none;">
          📧 Contact
        </a>
      </p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>