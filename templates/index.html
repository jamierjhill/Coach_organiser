<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tennis Match Organizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #2e7d32;
      color: #fff;
      margin: 20px;
      text-align: center;
    }
    h2, h3, label {
      color: #fff;
    }
    input, select, button {
      margin: 5px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #fff;
    }
    .player-list, .court-schedule-container {
      margin: 15px 0;
    }
    .court-schedule-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .court-schedule {
      border: 2px solid #ffffff;
      background-color: #1b5e20;
      padding: 10px;
      border-radius: 8px;
      width: 250px;
      min-height: 100px;
    }
    .match {
      padding: 5px;
      margin: 3px 0;
      background-color: #388e3c;
      border-radius: 5px;
      cursor: move;
    }
    .btn {
      background-color: #ffeb3b;
      color: #1b5e20;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
    }
    .btn:hover {
      background-color: #fdd835;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      background-color: #388e3c;
      padding: 5px;
      margin: 5px 0;
      border-radius: 5px;
    }
    .matches-box {
      margin-top: 20px;
      padding: 10px;
      background-color: #1b5e20;
      border: 2px solid #fff;
      border-radius: 8px;
      width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .timer-controls {
      margin: 20px auto;
      padding: 10px;
      background-color: #1b5e20;
      border: 2px solid #fff;
      border-radius: 8px;
      width: 300px;
    }
    .print-btn {
      margin-top: 20px;
      background-color: #81c784;
    }
  </style>
  <script>
    let timerInterval;
    let remainingTime = 1200;

    function updateClockDisplay(display) {
      const minutes = String(Math.floor(remainingTime / 60)).padStart(2, '0');
      const seconds = String(remainingTime % 60).padStart(2, '0');
      display.textContent = `${minutes}:${seconds}`;
    }

    function startClock(display) {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (remainingTime > 0) {
          remainingTime--;
          updateClockDisplay(display);
        } else {
          clearInterval(timerInterval);
          display.textContent = "Time's up!";
        }
      }, 1000);
    }

    function pauseClock() {
      clearInterval(timerInterval);
    }

    function setClockInput(display) {
      const minutes = parseInt(document.getElementById('custom-minutes').value);
      if (!isNaN(minutes) && minutes > 0 && minutes <= 200) {
        remainingTime = minutes * 60;
        updateClockDisplay(display);
      } else {
        alert("Please enter a number between 1 and 200.");
      }
    }

    function printPage() {
      window.print();
    }

    function enableDragDrop() {
      const items = document.querySelectorAll('.match');
      items.forEach(item => {
        item.setAttribute('draggable', 'true');
        item.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', e.target.id);
        });
      });

      const courts = document.querySelectorAll('.court-schedule');
      courts.forEach(court => {
        court.addEventListener('dragover', e => e.preventDefault());
        court.addEventListener('drop', e => {
          e.preventDefault();
          const id = e.dataTransfer.getData('text/plain');
          const match = document.getElementById(id);
          if (match && e.target.classList.contains('court-schedule')) {
            e.target.appendChild(match);
          }
        });
      });
    }

    window.onload = function () {
      const display = document.getElementById('main-timer-display');
      updateClockDisplay(display);
      enableDragDrop();
    };
  </script>
</head>
<body>
  <h2>ğŸ¾ Wardle Organizer ğŸ¾</h2>
  <form method="POST">
    <!--label>Session Name:</label>
    <input type="text" name="session_name" value="{{ session_name }}">
    <button type="submit" name="save_session" class="btn">Save Session</button>
    <button type="submit" name="load_session" class="btn">Load Session</button-->
    <br>
    <label>Number of courts:</label>
    <input type="number" name="courts" min="1" value="{{ courts }}">
    <label>Number of matches each:</label>
    <input type="number" name="num_matches" min="1" value="{{ num_matches }}">
    <label>Format:</label>
    <select name="match_type">
      <option value="singles" {% if match_type == "singles" %}selected{% endif %}>Singles</option>
      <option value="doubles" {% if match_type == "doubles" %}selected{% endif %}>Doubles</option>
    </select>
    <br>
    <label>Player Name:</label>
    <input type="text" name="name">
    <label>Grade:</label>
    <input type="number" name="grade" min="1" max="3">
    <button type="submit" name="add_player" class="btn">â• Add Player</button>
    <button type="submit" name="reset" class="btn">ğŸ” Reset</button>
    <button class="btn print-btn" onclick="printPage()">ğŸ–¨ï¸ Print as PDF</button>
    <button type="submit" name="organize_matches" class="btn">ğŸ¯ Organize Matches</button>
  </form>

  {% if error %}
    <p style="color: yellow; font-weight: bold;">âš ï¸ {{ error }}</p>
  {% endif %}

  <h3>ğŸ‘Ÿ Players ({{ players|length }}):</h3>
  <ul>
    {% for player in players %}
      <li>
        ğŸ§â€â™‚ï¸ {{ player.name }} (Grade {{ player.grade }})
        <form method="POST" style="display:inline;">
          <input type="hidden" name="remove_player" value="{{ player.name }}">
          <button type="submit" class="btn">ğŸ—‘ï¸ Remove</button>
        </form>
      </li>
    {% endfor %}
  </ul>

  <h3>ğŸ“‹ Match Schedules (Drag & Drop):</h3>
  <div class="court-schedule-container">
    {% for court_number in range(1, courts + 1) %}
      <div class="court-schedule" id="court-{{ court_number }}">
        <h3>Court {{ court_number }}</h3>
        {% if matchups[court_number - 1] %}
          {% for match, round_num in matchups[court_number - 1] %}
            {% set match_id = 'match-' ~ court_number ~ '-' ~ loop.index0 %}
            {% if match|length == 2 %}
              <p class="match" id="{{ match_id }}">{{ match[0].name }} (g{{ match[0].grade }}) vs. {{ match[1].name }} (g{{ match[1].grade }})<br><small>Round {{ round_num }}</small></p>
              {% elif match|length == 4 %}
              {% set team1_avg = ((match[0].grade + match[1].grade) / 2) | round(1) %}
              {% set team2_avg = ((match[2].grade + match[3].grade) / 2) | round(1) %}
              <p class="match" id="{{ match_id }}">
                {{ match[0].name }} & {{ match[1].name }} (Avg g{{ team1_avg }}) vs. {{ match[2].name }} & {{ match[3].name }} (Avg g{{ team2_avg }})
                <br><small>Round {{ round_num }}</small>
              </p>
            
            {% endif %}
          {% endfor %}
        {% else %}
          <p>No matches scheduled yet.</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <div class="matches-box">
    <h3>ğŸ§® Player Summary:</h3>
    <ul>
      {% for player, match_count in player_match_counts.items() %}
        <li><strong>{{ player }}</strong>: {{ match_count }} match{{ 'es' if match_count != 1 else '' }}</li>
      {% endfor %}
    </ul>
  </div>

  <div class="timer-controls">
    <h3>â±ï¸ Match Timer</h3>
    <div id="main-timer-display">20:00</div>
    <button class="btn" onclick="startClock(document.getElementById('main-timer-display'))">â–¶ï¸ Start</button>
    <button class="btn" onclick="pauseClock()">â¸ï¸ Pause</button>
    <br>
    <input type="number" id="custom-minutes" min="1" max="200" value="20">
    <button class="btn" onclick="setClockInput(document.getElementById('main-timer-display'))">Set Timer</button>
  </div>

  <div class="matches-box" style="margin-top: 30px;">
    <h3>ğŸ“‹ How the Matching Works</h3>
    <p style="text-align: left;">
      âœ… Players are matched with others who are close in grade (ability level).<br>
      âœ… Everyone gets a similar number of matches â€” no one is left out.<br>
      âœ… In doubles, balanced teams are made and matched based on team grade.<br>
      âœ… Repeat matchups are avoided unless necessary.<br>
      âœ… Prioritizes fairness, fun, and variety throughout the session. ğŸ¯
    </p>
  </div>

  <footer>
    <p>Cooked up by Jamie </p>
</body>
</html>
