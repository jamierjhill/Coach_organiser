{% extends "base.html" %}

{% block title %}ğŸ’° Invoices{% endblock %}

{% block extra_css %}
<style>
  /* Email Confirmation Modal Mobile Optimization */
  @media (max-width: 576px) {
    .modal-dialog {
      margin: 1rem;
      max-width: calc(100% - 2rem);
    }
    
    .modal-body {
      padding: 1rem;
    }
    
    .modal-footer {
      padding: 1rem;
      gap: 0.75rem !important;
    }
    
    .modal-footer .btn-base {
      min-height: 48px;
      font-size: 1rem;
    }
  }
  
  /* Modal content styling */
  #emailConfirmModal .modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  
  #emailConfirmModal .modal-header {
    border-bottom: 1px solid var(--light-border);
    background-color: var(--light);
    border-radius: 15px 15px 0 0;
  }
  
  #emailConfirmModal .modal-footer {
    border-top: none;
    background-color: var(--white);
    border-radius: 0 0 15px 15px;
  }
  
  /* Confirmation content styling */
  .text-teal {
    color: var(--teal) !important;
    font-weight: 500;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">ğŸ’° Invoices</h1>
  <div class="title-nav-buttons">
    <a href="/invoices/clients" class="btn-base btn-outline-accent">ğŸ‘¥ Clients</a>
    <a href="/invoices/create" class="btn-base btn-accent">â• New Invoice</a>
    <a href="/invoices/analytics" class="btn-base btn-outline-secondary">ğŸ“Š Analytics</a>
  </div>
</div>

<!-- Financial Summary -->
<div class="summary-grid">
  <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white;">
    <div class="summary-amount">Â£{{ "%.0f"|format(total_unpaid) }}</div>
    <div class="summary-label">Outstanding</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: white;">
    <div class="summary-amount">Â£{{ "%.0f"|format(total_paid) }}</div>
    <div class="summary-label">Received</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--danger), #c0392b); color: white;">
    <div class="summary-amount">{{ num_overdue }}</div>
    <div class="summary-label">Overdue</div>
  </div>
</div>

<!-- Search and Filters -->
<div class="card-base">
  <div class="flex flex-between mb-3">
    <input type="text" id="searchInput" class="input-base" placeholder="ğŸ” Search invoices..." style="flex: 1; margin-right: 1rem;">
    <select id="statusFilter" class="input-base" style="width: auto;">
      <option value="all">All Status</option>
      <option value="unpaid">Unpaid</option>
      <option value="overdue">Overdue</option>
      <option value="paid">Paid</option>
    </select>
  </div>
  <button onclick="clearFilters()" class="btn-base btn-outline-secondary btn-sm">Clear Filters</button>
</div>

<!-- Unpaid Invoices Section -->
{% if unpaid_invoices %}
<div class="card-base">
  <h4 class="section-title">âš ï¸ Unpaid Invoices ({{ unpaid_invoices|length }})</h4>
  
  {% for invoice in unpaid_invoices %}
  <div class="invoice-item card-border-left hover-subtle mb-3" 
       data-status="{{ invoice.status }}" 
       data-search="{{ (invoice.client_name + ' ' + invoice.invoice_number + ' ' + invoice.description)|lower }}">
    
    <div class="flex flex-between align-items-center mb-2">
      <div class="flex-grow-1">
        <div class="flex align-items-center mb-1">
          <h6 class="font-medium mb-0">{{ invoice.client_name }}</h6>
          <span class="badge-base status-{{ 'danger' if invoice.status == 'overdue' else 'warning' }} ml-2">
            {{ invoice.status.upper() }}
          </span>
        </div>
        <div class="text-sm text-muted">
          <strong>{{ invoice.invoice_number }}</strong> â€¢ {{ invoice.description }}<br>
          Due: {{ invoice.due_date }}
          {% if invoice.client_email and invoice.email_sent %}
          â€¢ <span class="text-info">ğŸ“§ Sent</span>
          {% endif %}
        </div>
      </div>
      
      <div class="text-right">
        <div class="text-xl font-bold" style="color: {{ 'var(--danger)' if invoice.status == 'overdue' else 'var(--warning)' }};">
          Â£{{ "%.0f"|format(invoice.amount) }}
        </div>
      </div>
    </div>
    
    <div class="flex flex-wrap" style="gap: 0.5rem;">
      <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST" style="display: inline;">
        <button type="submit" class="btn-base btn-success btn-sm">âœ… Paid</button>
      </form>
      <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-sm">ğŸ‘ï¸ View</a>
      <button onclick="quickShare('{{ invoice.id }}')" class="btn-base btn-outline-secondary btn-sm">ğŸ“± Share</button>
      {% if invoice.client_email %}
      <button onclick="quickEmail('{{ invoice.id }}', '{{ invoice.invoice_number }}', '{{ invoice.client_name }}', '{{ invoice.client_email }}')" 
              class="btn-base btn-info btn-sm">ğŸ“§ Email</button>
      {% endif %}
    </div>
    
    <!-- Hidden sharing data -->
    <div class="invoice-data" id="invoice-{{ invoice.id }}" style="display: none;">
ğŸ¾ INVOICE {{ invoice.invoice_number }}

From: {{ current_user.username|title }} (Tennis Coach)
To: {{ invoice.client_name }}
Service: {{ invoice.description }}
Amount: Â£{{ "%.2f"|format(invoice.amount) }}
Due: {{ invoice.due_date }}
Status: {{ invoice.status.upper() }}

Thank you!
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Paid Invoices Section -->
{% if paid_invoices %}
<div class="card-base">
  <h4 class="section-title">âœ… Paid Invoices ({{ paid_invoices|length }})</h4>
  
  {% for invoice in paid_invoices[:10] %}
  <div class="invoice-item card-border-left hover-subtle mb-3"
       data-status="{{ invoice.status }}"
       data-search="{{ (invoice.client_name + ' ' + invoice.invoice_number + ' ' + invoice.description)|lower }}">
    
    <div class="flex flex-between align-items-center">
      <div class="flex-grow-1">
        <div class="flex align-items-center mb-1">
          <h6 class="font-medium mb-0">{{ invoice.client_name }}</h6>
          <span class="badge-base status-success ml-2">PAID</span>
        </div>
        <div class="text-sm text-muted">
          <strong>{{ invoice.invoice_number }}</strong> â€¢ {{ invoice.description }}<br>
          Paid: {{ invoice.paid_date if invoice.paid_date else "Recently" }}
        </div>
      </div>
      
      <div class="text-right">
        <div class="text-xl font-bold text-success">Â£{{ "%.0f"|format(invoice.amount) }}</div>
        <div class="flex" style="gap: 0.5rem; margin-top: 0.5rem;">
          <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-sm">ğŸ‘ï¸ View</a>
          <a href="/invoices/duplicate/{{ invoice.id }}" class="btn-base btn-outline-secondary btn-sm">ğŸ”„ Copy</a>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  
  {% if paid_invoices|length > 10 %}
  <div class="text-center">
    <p class="text-muted">Showing 10 of {{ paid_invoices|length }} paid invoices</p>
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Empty State -->
{% if not unpaid_invoices and not paid_invoices %}
<div class="card-base">
  <div class="empty-state">
    <div class="empty-icon">ğŸ’°</div>
    <h4>Welcome to Invoices!</h4>
    <p>Start managing your tennis coaching payments professionally.</p>
    
    <div class="flex flex-column" style="gap: 1rem; align-items: center; margin-top: 1.5rem;">
      <a href="/invoices/create" class="btn-base btn-accent">Create First Invoice</a>
      <a href="/invoices/templates" class="btn-base btn-outline-accent">Set Up Templates</a>
    </div>
  </div>
</div>
{% endif %}

<!-- Email Confirmation Modal -->
<div class="modal fade" id="emailConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title h5">ğŸ“§ Confirm Email Send</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“§</div>
          <h6 class="mb-2">Send Invoice Email?</h6>
          <p class="text-muted mb-3">This will send invoice <strong id="confirmInvoiceNumber"></strong> to <strong id="confirmClientName"></strong></p>
          <div class="card-border-left" style="background-color: rgba(0, 160, 126, 0.05);">
            <div class="text-sm">
              <strong>Email will be sent to:</strong><br>
              <span id="confirmClientEmail" class="text-teal"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer flex-column" style="gap: 0.5rem;">
        <button type="button" id="confirmEmailSend" class="btn-base btn-accent w-100">
          âœ… Yes, Send Email
        </button>
        <button type="button" class="btn-base btn-outline-secondary w-100" data-bs-dismiss="modal">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  let allInvoiceItems = [];
  let currentInvoiceId = null;
  let emailConfirmModal = null;
  
  document.addEventListener('DOMContentLoaded', function() {
    allInvoiceItems = Array.from(document.querySelectorAll('.invoice-item'));
    emailConfirmModal = new bootstrap.Modal(document.getElementById('emailConfirmModal'));
    
    // Initialize search and filter
    document.getElementById('searchInput')?.addEventListener('input', performSearch);
    document.getElementById('statusFilter')?.addEventListener('change', performSearch);
    
    // Set up email confirmation handler
    document.getElementById('confirmEmailSend')?.addEventListener('click', function() {
      if (currentInvoiceId) {
        emailConfirmModal.hide();
        sendEmailToInvoice(currentInvoiceId);
      }
    });
  });
  
  function performSearch() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || 'all';
    
    allInvoiceItems.forEach(item => {
      const searchContent = item.dataset.search || '';
      const status = item.dataset.status || '';
      
      const matchesSearch = !searchTerm || searchContent.includes(searchTerm);
      const matchesFilter = statusFilter === 'all' || status === statusFilter;
      
      item.style.display = (matchesSearch && matchesFilter) ? 'block' : 'none';
    });
  }
  
  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    performSearch();
  }
  
  function quickShare(invoiceId) {
    const invoiceData = document.getElementById(`invoice-${invoiceId}`);
    if (!invoiceData) return;
    
    const text = invoiceData.textContent.trim();
    
    if (navigator.share) {
      navigator.share({
        title: 'Tennis Invoice',
        text: text
      });
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('âœ… Invoice copied to clipboard!');
      });
    } else {
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    }
  }
  
  function quickEmail(invoiceId, invoiceNumber, clientName, clientEmail) {
    // Store current invoice ID and details
    currentInvoiceId = invoiceId;
    
    // Populate modal with invoice details
    document.getElementById('confirmInvoiceNumber').textContent = invoiceNumber;
    document.getElementById('confirmClientName').textContent = clientName;
    document.getElementById('confirmClientEmail').textContent = clientEmail;
    
    // Show confirmation modal
    emailConfirmModal.show();
  }
  
  function sendEmailToInvoice(invoiceId) {
    // Find the email button for this invoice by looking for the onclick attribute
    const emailButtons = document.querySelectorAll('button[onclick*="quickEmail"]');
    let emailButton = null;
    
    emailButtons.forEach(btn => {
      if (btn.getAttribute('onclick').includes(`'${invoiceId}'`)) {
        emailButton = btn;
      }
    });
    
    if (!emailButton) {
      showToast('âŒ Email button not found');
      return;
    }
    
    const originalText = emailButton.innerHTML;
    
    emailButton.innerHTML = 'â³ Sending...';
    emailButton.disabled = true;
    
    fetch(`/invoices/send-email/${invoiceId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('ğŸ“§ Email sent successfully!');
        emailButton.innerHTML = 'âœ… Sent';
        
        // Update the invoice item to show email was sent
        const invoiceItem = emailButton.closest('.invoice-item');
        if (invoiceItem) {
          const statusArea = invoiceItem.querySelector('.text-sm.text-muted');
          if (statusArea && !statusArea.textContent.includes('ğŸ“§ Sent')) {
            statusArea.innerHTML += ' â€¢ <span class="text-info">ğŸ“§ Sent</span>';
          }
        }
      } else {
        showToast(`âŒ ${data.error}`);
        emailButton.innerHTML = originalText;
      }
    })
    .catch(error => {
      console.error('Email send error:', error);
      showToast('âŒ Failed to send email. Please try again.');
      emailButton.innerHTML = originalText;
    })
    .finally(() => {
      emailButton.disabled = false;
      setTimeout(() => {
        if (emailButton.innerHTML.includes('âœ…')) {
          emailButton.innerHTML = 'ğŸ“§ Email';
        }
      }, 3000);
    });
  }
  
  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed animate-fade-in';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
{% endblock %}