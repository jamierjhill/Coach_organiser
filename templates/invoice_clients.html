{% extends "base.html" %}

{% block title %}ğŸ‘¥ Clients{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">ğŸ‘¥ Client Dashboard</h1>
  <div class="title-nav-buttons">
    <a href="/invoices" class="btn-base btn-outline-accent">â† Back to Invoices</a>
    <a href="/invoices/create" class="btn-base btn-accent">â• New Invoice</a>
  </div>
</div>

<!-- Client Summary Stats -->
<div class="card-base">
  <div class="row text-center g-3">
    <div class="col-md-4 col-6">
      <div class="summary-card" style="background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: white; padding: 1rem; border-radius: 12px;">
        <div class="h3 mb-0 font-bold">{{ total_clients }}</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">Total Clients</div>
      </div>
    </div>
    <div class="col-md-4 col-6">
      <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white; padding: 1rem; border-radius: 12px;">
        <div class="h3 mb-0 font-bold">{{ clients_with_outstanding }}</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">With Outstanding</div>
      </div>
    </div>
    <div class="col-md-4 col-12">
      <div class="summary-card" style="background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: white; padding: 1rem; border-radius: 12px;">
        <div class="h3 mb-0 font-bold">Â£{{ "%.0f"|format(total_outstanding_all) }}</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">Total Outstanding</div>
      </div>
    </div>
  </div>
</div>

<!-- Search and Filter -->
<div class="card-base">
  <h4 class="section-title">ğŸ” Find Clients</h4>
  
  <div class="row g-3 align-items-end">
    <div class="col-md-8">
      <label class="form-label">Search clients</label>
      <div class="position-relative">
        <input type="text" id="clientSearch" class="input-base" 
               placeholder="Search by client name..." 
               style="padding-right: 40px;">
        <button onclick="clearClientSearch()" id="clearClientSearchBtn" 
                class="btn-base btn-outline-secondary btn-sm position-absolute" 
                style="right: 5px; top: 50%; transform: translateY(-50%); display: none; padding: 2px 8px;">
          âœ•
        </button>
      </div>
    </div>
    
    <div class="col-md-4">
      <label class="form-label">Filter</label>
      <select id="clientFilter" class="input-base">
        <option value="all">All Clients</option>
        <option value="outstanding">With Outstanding</option>
        <option value="paid-up">Paid Up</option>
        <option value="overdue">With Overdue</option>
      </select>
    </div>
  </div>
</div>

<!-- Client List -->
{% if clients %}
<div class="card-base">
  <h4 class="section-title">Your Clients ({{ clients|length }})</h4>
  
  <div class="row g-3" id="clientsList">
    {% for client in clients %}
    <div class="col-lg-6 col-xl-4 client-card" 
         data-client-name="{{ client.name|lower }}"
         data-has-outstanding="{{ 'true' if client.total_outstanding > 0 else 'false' }}"
         data-has-overdue="{{ 'true' if client.total_overdue > 0 else 'false' }}">
      
      <div class="card-border-left hover-subtle" 
           style="border-left-color: {% if client.total_overdue > 0 %}var(--danger){% elif client.total_outstanding > 0 %}var(--warning){% else %}var(--success){% endif %};">
        
        <!-- Client Header -->
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div class="flex-grow-1">
            <h5 class="mb-1 font-medium">{{ client.name }}</h5>
            <div class="text-sm text-muted">{{ client.total_invoices }} invoice{{ 's' if client.total_invoices != 1 else '' }}</div>
          </div>
          
          <!-- Status Badge -->
          {% if client.total_overdue > 0 %}
            <span class="badge-base status-danger">OVERDUE</span>
          {% elif client.total_outstanding > 0 %}
            <span class="badge-base status-warning">OUTSTANDING</span>
          {% else %}
            <span class="badge-base status-success">PAID UP</span>
          {% endif %}
        </div>
        
        <!-- Financial Summary -->
        <div class="row g-2 mb-3">
          {% if client.total_outstanding > 0 %}
          <div class="col-6">
            <div class="text-center p-2" style="background-color: rgba(247, 201, 72, 0.1); border-radius: 8px;">
              <div class="font-bold text-lg" style="color: var(--warning);">Â£{{ "%.0f"|format(client.total_outstanding) }}</div>
              <div class="text-xs text-muted">Outstanding</div>
            </div>
          </div>
          {% endif %}
          
          {% if client.total_paid > 0 %}
          <div class="col-{{ '6' if client.total_outstanding > 0 else '12' }}">
            <div class="text-center p-2" style="background-color: rgba(0, 160, 126, 0.1); border-radius: 8px;">
              <div class="font-bold text-lg" style="color: var(--teal);">Â£{{ "%.0f"|format(client.total_paid) }}</div>
              <div class="text-xs text-muted">Total Paid</div>
            </div>
          </div>
          {% endif %}
        </div>
        
        <!-- Last Activity -->
        {% if client.last_invoice_date or client.last_payment_date %}
        <div class="mb-3">
          {% if client.last_payment_date %}
            <div class="text-xs text-muted">Last payment: {{ client.last_payment_date }}</div>
          {% endif %}
          {% if client.last_invoice_date %}
            <div class="text-xs text-muted">Last invoice: {{ client.last_invoice_date }}</div>
          {% endif %}
        </div>
        {% endif %}
        
        <!-- Quick Actions -->
        <div class="d-flex gap-2 flex-wrap">
          <a href="/invoices/clients/{{ client.name }}" class="btn-base btn-accent btn-sm flex-fill">
            ğŸ‘ï¸ View Details
          </a>
          <a href="/invoices/clients/{{ client.name }}/create" class="btn-base btn-outline-accent btn-sm">
            â• New Invoice
          </a>
          {% if client.total_outstanding > 0 %}
          <button onclick="shareOutstandingReminder('{{ client.name }}', {{ client.total_outstanding }})" 
                  class="btn-base btn-outline-secondary btn-sm" title="Send payment reminder">
            ğŸ“±
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- No results message -->
  <div id="noClientsMessage" style="display: none;" class="text-center py-4">
    <div class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <p>No clients match your search criteria</p>
      <button onclick="clearAllClientFilters()" class="btn-base btn-outline-accent btn-sm">
        Clear Filters
      </button>
    </div>
  </div>
</div>

{% else %}
<!-- Empty State -->
<div class="card-base text-center">
  <div class="empty-state">
    <div class="empty-icon">ğŸ‘¥</div>
    <h4 class="mb-3">No Clients Yet</h4>
    <p class="mb-4 text-muted">Create your first invoice to start building your client base.</p>
    <a href="/invoices/create" class="btn-base btn-accent btn-lg">âœ¨ Create First Invoice</a>
  </div>
</div>
{% endif %}

<!-- Quick Tips -->
<div class="card-base" style="background-color: rgba(0, 160, 126, 0.05); border: 1px solid rgba(0, 160, 126, 0.2);">
  <h5 class="mb-3">ğŸ’¡ Client Management Tips</h5>
  <ul class="mb-0" style="padding-left: 1.2rem;">
    <li class="mb-2">Click on any client to see their complete invoice history</li>
    <li class="mb-2">Use the ğŸ“± button to quickly send payment reminders via WhatsApp</li>
    <li class="mb-2">Clients are sorted by outstanding amount (highest first)</li>
    <li class="mb-0">The color coding helps you spot overdue accounts at a glance</li>
  </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Search and filter functionality
  let allClientCards = [];
  
  document.addEventListener('DOMContentLoaded', function() {
    initializeClientSearch();
  });
  
  function initializeClientSearch() {
    const searchInput = document.getElementById('clientSearch');
    const clientFilter = document.getElementById('clientFilter');
    
    // Store all client card elements
    allClientCards = Array.from(document.querySelectorAll('.client-card'));
    
    // Add event listeners
    searchInput.addEventListener('input', performClientSearch);
    clientFilter.addEventListener('change', performClientSearch);
    
    // Clear search button
    searchInput.addEventListener('input', function() {
      const clearBtn = document.getElementById('clearClientSearchBtn');
      clearBtn.style.display = this.value ? 'block' : 'none';
    });
  }
  
  function performClientSearch() {
    const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
    const filterValue = document.getElementById('clientFilter').value;
    
    let visibleCount = 0;
    
    allClientCards.forEach(card => {
      const clientName = card.dataset.clientName || '';
      const hasOutstanding = card.dataset.hasOutstanding === 'true';
      const hasOverdue = card.dataset.hasOverdue === 'true';
      
      // Text search
      const matchesSearch = !searchTerm || clientName.includes(searchTerm);
      
      // Filter logic
      let matchesFilter = true;
      switch (filterValue) {
        case 'outstanding':
          matchesFilter = hasOutstanding;
          break;
        case 'paid-up':
          matchesFilter = !hasOutstanding;
          break;
        case 'overdue':
          matchesFilter = hasOverdue;
          break;
        case 'all':
        default:
          matchesFilter = true;
      }
      
      const shouldShow = matchesSearch && matchesFilter;
      card.style.display = shouldShow ? 'block' : 'none';
      
      if (shouldShow) visibleCount++;
    });
    
    // Show/hide no results message
    const noResultsMsg = document.getElementById('noClientsMessage');
    if (noResultsMsg) {
      noResultsMsg.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }
  
  function clearClientSearch() {
    document.getElementById('clientSearch').value = '';
    document.getElementById('clearClientSearchBtn').style.display = 'none';
    performClientSearch();
  }
  
  function clearAllClientFilters() {
    document.getElementById('clientSearch').value = '';
    document.getElementById('clientFilter').value = 'all';
    document.getElementById('clearClientSearchBtn').style.display = 'none';
    performClientSearch();
  }
  
  // Share outstanding reminder via WhatsApp
  function shareOutstandingReminder(clientName, outstandingAmount) {
    const message = `Hi ${clientName},

Hope you're well! Just a friendly reminder that you have an outstanding balance of Â£${outstandingAmount.toFixed(2)} for tennis coaching.

If you've already made payment, please ignore this message. Otherwise, please let me know if you need any details about the invoice.

Thanks!
- ${getCurrentCoachName()}`;
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
    
    window.open(whatsappUrl, '_blank');
    showToast('ğŸ“± Opening WhatsApp with payment reminder...', 'info');
  }
  
  function getCurrentCoachName() {
    // Try to get coach name from current user, fallback to generic
    return '{{ current_user.username|title if current_user.username else "Your Coach" }}';
  }
  
  // Show toast notification
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show animate-fade-in position-fixed`;
    toast.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 1050;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 34, 62, 0.15);
    `;
    
    toast.innerHTML = `
      ${message}
      <button type="button" class="btn-close" onclick="this.parentElement.remove()" aria-label="Close"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }
    }, 3000);
  }
</script>
{% endblock %}