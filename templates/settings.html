{% extends "base.html" %}

{% block title %}âš™ï¸ Settings{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">âš™ï¸ Settings</h1>

</div>

<!-- Account Information -->
<div class="card-base">
  <h4 class="section-title">ğŸ‘¤ Account Information</h4>
  <div class="mb-3">
    <p><strong>Username:</strong> {{ current_user.username }}</p>
  </div>
</div>

<!-- Location Settings -->
<div class="card-section">
  <h4>ğŸ“ Location Settings</h4>
  <form method="POST">
    <div class="mb-3">
      <label class="form-label">Default Location for Weather</label>
      <input type="text" class="form-control" id="postcodeInput" name="postcode" value="{{ user_settings.default_postcode or '' }}" placeholder="e.g. SW6 4UL">
      <div class="form-text">This postcode is used for weather forecasts and local information.</div>
    </div>
    <button type="submit" class="btn tennis-btn">ğŸ’¾ Save Location</button>
  </form>
</div>

<!-- Password Settings -->
<div class="card-section">
  <h4>ğŸ” Security</h4>
  <form method="POST">
    <div class="mb-3">
      <label class="form-label">Current Password</label>
      <input type="password" class="form-control" name="current_password" placeholder="Enter current password">
    </div>
    <div class="mb-3">
      <label class="form-label">New Password</label>
      <input type="password" class="form-control" name="new_password" placeholder="Enter new password">
    </div>
    <button type="submit" class="btn tennis-btn">ğŸ’¾ Update Password</button>
  </form>
</div>

<!-- Add to templates/settings.html -->
<div class="card-section">
  <h4>ğŸ“Š Data Privacy</h4>
  <div class="d-flex">
    <a href="/download-data" class="btn tennis-btn me-2">ğŸ“¥ Download My Data</a>
  </div>
</div>

<!-- Danger Zone -->
<div class="card-section">
  <h4>âš ï¸ Danger Zone</h4>
  <p class="text-muted">Permanently delete your account and all associated data.</p>
  <form method="POST" action="/delete-account" onsubmit="return confirm('Are you sure you want to delete your account? This cannot be undone.');">
    <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ Delete Account</button>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function autoSaveLocation() {
    const postcode = document.getElementById("postcodeInput").value.trim();

    const data = new URLSearchParams();
    data.append("postcode", postcode);

    fetch("/settings", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: data
    }).then(res => {
      if (res.redirected) {
        window.location.href = res.url;
      }
    });
  }

  document.getElementById("postcodeInput").addEventListener("blur", autoSaveLocation);
</script>
{% endblock %}